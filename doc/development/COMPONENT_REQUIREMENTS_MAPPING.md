# コンポーネント別要件マッピング表

## 📋 **概要**
このドキュメントは各Reactコンポーネントと要件書（RDv1.1.5.1.md）の対応関係を明記し、要件乖離を防ぐためのリファレンスとして使用します。

---

## 🎯 **Core Workspace Components**

### **AuthenticatedWorkspace.tsx**
- **要件書**: 2.2, 5.1, 5.2
- **責任**: 認証済みユーザーのワークスペース
- **必須要件**:
  - ✅ 保存ボタン非表示（自動保存のため）
  - ✅ 自動保存インジケーター表示
  - ✅ 検索ツールバー統合
  - ✅ 設定ボタンのみ右上に配置
- **禁止事項**:
  - ❌ 手動保存ボタンの表示
  - ❌ 右上エリアへのメモ作成ボタン配置

### **GuestWorkspace.tsx**
- **要件書**: 1.2, 1.3, 5.1, 5.2
- **責任**: ゲストユーザーのワークスペース
- **必須要件**:
  - ✅ 右上に手動保存ボタン表示
  - ✅ フォルダ選択ダイアログ呼び出し
  - ✅ 既存AMV-system構造検出・マージ
  - ✅ ゲストフォルダパス記憶機能
- **禁止事項**:
  - ❌ 自動保存機能の実装
  - ❌ 暗号化保存（平文のみ）

### **WorkspaceCanvas.tsx**
- **要件書**: 一般的なキャンバス仕様（明示的記載なし）
- **責任**: メモ表示・操作キャンバス
- **必須要件**:
  - ✅ ドラッグ&ドロップ操作
  - ✅ メモリサイズ変更
  - ✅ z-index管理
  - ✅ ズーム・パン機能

---

## 🔧 **UI Components**

### **ToolSelector.tsx (LayoutSelector)**
- **要件書**: 明示的記載なし（ユーザー要求による配置指定）
- **責任**: メモ作成ツールバー
- **必須要件**:
  - ✅ 下部固定配置（bottom-4）
  - ✅ メモ作成ボタンのみ提供
  - ✅ キャンバス中心座標でのメモ作成
- **禁止事項**:
  - ❌ 右上エリアでの重複配置

### **AdaptiveSidebar.tsx**
- **要件書**: 明示的記載なし（情報量別表示機能）
- **責任**: メモ一覧・検索・フィルタリング
- **必須要件**:
  - ✅ 検索クエリ処理
  - ✅ メモ可視性切り替え
  - ✅ キャンバスフォーカス機能
  - ✅ 適応的表示切り替え

### **SearchToolbar.tsx / AdvancedSearchBox.tsx**
- **要件書**: Phase 2.1実装（追加機能）
- **責任**: 高度検索機能
- **必須要件**:
  - ✅ TinySegmenter日本語形態素解析
  - ✅ TF-IDF relevance scoring
  - ✅ タグベース検索
  - ✅ 検索履歴・候補機能

---

## 🔐 **Authentication & Data Management**

### **AuthForm.tsx**
- **要件書**: 2.1, 2.5.1
- **責任**: ログイン・アカウント作成
- **必須要件**:
  - ✅ JWTトークン管理
  - ✅ パスワード暗号化鍵生成
  - ✅ 自動ログイン検証
  - ✅ アカウント-ディレクトリ関連付け

### **useAuth.ts**
- **要件書**: 2.1, 2.5.1, 3.1
- **責任**: 認証状態管理
- **必須要件**:
  - ✅ 自動ログイン検証
  - ✅ JWTトークン検証
  - ✅ ログアウト時の状態クリア
  - ✅ アカウントUUID管理

### **useLoadAfterLogin.ts**
- **要件書**: 2.1, 2.5.1, 2.5.2, 2.5.3
- **責任**: ログイン後のデータ復元
- **必須要件**:
  - ✅ 自動ディレクトリ復元試行
  - ✅ 手動フォルダ選択フォールバック
  - ✅ 既存メモのストア反映（**修正済み**）
  - ✅ アカウント関連付け保存
- **修正実績**:
  - 🔧 `setMemos(existingMemos)` 呼び出し追加（行100-102）

---

## 💾 **File System & Storage**

### **useMemos.ts**
- **要件書**: 2.2, 4.1, 8.1
- **責任**: メモ状態管理・自動保存
- **必須要件**:
  - ✅ 500msデバウンス自動保存
  - ✅ 認証時のみ自動保存実行
  - ✅ Clean Architecture対応（Optional）
  - ✅ Legacy モードフォールバック
- **禁止事項**:
  - ❌ ゲストモードでの自動保存

### **fileAccess.ts**
- **要件書**: 4.2, 4.3, 6.1, 6.2, 7.1
- **責任**: ファイルシステム操作
- **必須要件**:
  - ✅ AMV-system標準構造作成
  - ✅ 認証時暗号化・ゲスト時平文
  - ✅ メタデータ管理
  - ✅ 重複防止システム
  - ✅ アカウント関連付けファイル管理

### **dirHandleStore.ts**
- **要件書**: 1.5, 2.5.2
- **責任**: ディレクトリハンドル永続化
- **必須要件**:
  - ✅ localStorage情報記憶
  - ✅ ハンドル有効性検証
  - ✅ ゲストモード永続化対応

---

## ⚙️ **Settings & Configuration**

### **SettingsModal.tsx / useSettings.ts**
- **要件書**: 一般的な設定機能（詳細な要件なし）
- **責任**: アプリケーション設定管理
- **必須要件**:
  - ✅ テーマ設定
  - ✅ 言語設定
  - ✅ ファイルシステム設定
  - ✅ 設定ファイル保存・読み込み

---

## 🚫 **禁止パターン（要件乖離防止）**

### **UI配置の禁止事項**
1. **右上エリアへのメモ作成ボタン配置**
   - ❌ AuthenticatedWorkspace.tsx内
   - ❌ GuestWorkspace.tsx内
   - ✅ 許可：ToolSelector.tsx（下部のみ）

2. **保存ボタンの不適切な表示**
   - ❌ 認証時の手動保存ボタン表示
   - ❌ ゲスト時の自動保存機能実装

3. **データフローの不備**
   - ❌ ファイル読み込み後のストア反映忘れ
   - ❌ 認証状態無視の機能実装

### **実装時チェックポイント**
```typescript
// ❌ 禁止: 認証時の手動保存ボタン
{isLoggedIn && (
  <button onClick={handleSave}>保存</button>  // 要件違反
)}

// ✅ 正しい: 認証時は自動保存のみ
{isLoggedIn ? (
  <div>自動保存中</div>
) : (
  <button onClick={handleSave}>保存</button>
)}
```

---

## 📝 **変更時の確認手順**

### **Component変更前チェック**
1. このマッピング表で該当要件を確認
2. RDv1.1.5.1.mdの該当セクション精読
3. 認証状態別の動作確認
4. 既存機能への影響調査

### **実装後検証**
1. E2Eテストでの動作確認
2. 要件マッピング表の更新
3. 新機能の要件書記載確認
4. CLAUDE.mdへの変更記録

---

## 📊 **要件充足率**

| 要件カテゴリ | 実装済み | 要件乖離修正 | 今後実装 |
|-------------|----------|-------------|----------|
| ゲストモード | ✅ 100% | 🔧 右上ボタン削除 | - |
| 認証モード | ✅ 100% | 🔧 ファイル読み取り修正 | - |
| 自動ログイン | ✅ 100% | - | - |
| ファイル管理 | ✅ 100% | - | - |
| 検索機能 | ✅ Phase 2.1完了 | - | - |
| セキュリティ | ✅ 100% | - | - |

**総合充足率: 100%**（要件乖離修正済み）

---

## 🔄 **更新履歴**
- **2025-01-07**: 初版作成、要件乖離修正記録
- **次回更新**: 新機能追加時、要件書更新時